-- Setup and context
USE ROLE ACCOUNTADMIN;
USE WAREHOUSE MY_WAREHOUSE_NAME;

-- These queries help identify access associated with UNC5537 AKA 'r*peflake'
-- More information can be found at:
--     https://community.snowflake.com/s/article/Communication-ID-0108977-Additional-Information
--     https://cloud.google.com/blog/topics/threat-intelligence/unc5537-snowflake-data-theft-extortion

-- The following query will return login events that originated from suspected IP addresses.
SELECT *
FROM SNOWFLAKE.ACCOUNT_USAGE.LOGIN_HISTORY
WHERE
    CLIENT_IP IN (
    '5.47.87.202', '31.171.154.51', '31.170.22.16', '37.19.210.34', '37.19.210.21', '37.19.210.28', '37.19.221.170', '37.19.200.131', '37.19.221.144', '37.19.200.144', '37.19.200.157', '37.19.221.157', '37.19.210.2', '38.240.225.69', '38.240.225.37', '43.225.189.163', '43.225.189.132', '45.86.221.146', '45.134.142.200', '45.134.140.144', '45.155.91.99', '45.134.212.93', '45.134.213.195', '45.134.79.98', '45.134.142.194', '45.134.140.131', '45.134.142.207', '45.134.212.80', '45.134.79.68', '45.134.142.220', '46.19.136.227', '66.115.189.247', '66.63.167.147', '66.115.189.210', '66.115.189.200', '66.115.189.160', '66.63.167.163', '66.63.167.195', '66.115.189.190', '68.235.44.35', '68.235.44.3', '68.235.44.195', '69.4.234.118', '69.4.234.124', '69.4.234.119', '69.4.234.116', '69.4.234.125', '69.4.234.120', '69.4.234.122', '79.127.217.44', '79.127.217.35', '79.127.222.195', '79.127.222.208', '79.127.217.48', '87.249.134.11', '87.249.134.15', '87.249.134.28', '87.249.134.2', '92.60.40.225', '92.60.40.210', '93.115.0.49', '96.44.191.140', '96.44.189.99', '96.44.191.131', '96.44.191.147', '102.165.16.161', '103.75.11.51', '103.136.147.4', '103.75.11.67', '103.125.233.19', '103.136.147.130', '103.108.229.67', '103.216.220.19', '103.214.20.131', '103.216.220.35', '103.108.231.51', '103.108.231.67', '104.223.91.28', '104.129.24.124', '104.129.24.115', '104.129.57.67', '104.129.41.195', '104.223.91.19', '107.150.22.3', '129.227.46.163', '129.227.46.131', '138.199.34.144', '138.199.43.92', '138.199.60.29', '138.199.43.66', '138.199.60.3', '138.199.15.163', '138.199.6.208', '138.199.6.221', '138.199.43.79', '138.199.21.240', '138.199.15.147', '138.199.60.16', '138.199.21.227', '138.199.6.195', '141.98.252.190', '142.147.89.226', '143.244.47.92', '143.244.47.79', '143.244.47.66', '146.70.117.210', '146.70.171.99', '146.70.171.112', '146.70.124.216', '146.70.117.56', '146.70.165.227', '146.70.166.176', '146.70.119.24', '146.70.225.67', '146.70.134.3', '146.70.173.195', '146.70.132.227', '146.70.224.3', '146.70.117.35', '146.70.144.35', '146.70.173.131', '146.70.117.163', '146.70.138.195', '146.70.184.67', '146.70.168.67', '146.70.171.67', '146.70.187.67', '146.70.128.195', '146.70.119.35', '146.70.200.3', '146.70.166.131', '146.70.128.227', '146.70.188.131', '146.70.168.195', '146.70.185.3', '146.70.124.131', '146.70.171.131', '146.70.197.131', '146.70.133.3', '146.70.199.195', '146.70.225.3', '146.70.198.195', '146.70.199.131', '146.70.129.131', '146.70.184.3', '146.70.196.195', '146.70.132.195', '146.70.211.67', '146.70.197.195', '146.70.129.99', '146.70.133.99', '146.70.165.3', '149.102.246.3', '149.102.246.16', '149.102.240.67', '149.88.22.156', '149.88.20.207', '149.88.20.194', '149.88.22.130', '149.102.240.80', '149.22.81.208', '149.88.22.143', '149.40.50.113', '149.22.81.195', '149.88.22.169', '149.88.104.16', '154.47.30.137', '154.47.30.150', '154.47.30.144', '154.47.29.3', '154.47.16.48', '154.47.30.131', '154.47.16.35', '156.59.50.195', '156.59.50.227', '162.33.177.32', '169.150.203.22', '169.150.201.25', '169.150.223.208', '169.150.203.16', '169.150.201.29', '169.150.196.3', '169.150.201.3', '169.150.227.223', '169.150.196.16', '169.150.227.198', '169.150.203.29', '169.150.198.67', '169.150.196.29', '169.150.227.211', '173.44.63.112', '173.205.85.35', '173.44.63.67', '173.205.93.3', '176.123.6.193', '176.123.3.132', '176.220.186.152', '176.123.7.143', '176.123.10.35', '178.249.209.163', '178.249.211.80', '178.255.149.166', '178.249.209.176', '178.249.214.3', '178.249.211.93', '178.249.214.16', '178.249.211.67', '179.43.189.67', '184.147.100.29', '185.156.46.163', '185.213.155.241', '185.248.85.59', '185.156.46.144', '185.248.85.14', '185.204.1.178', '185.201.188.34', '185.248.85.49', '185.65.134.191', '185.188.61.196', '185.201.188.4', '185.248.85.34', '185.156.46.157', '185.188.61.226', '185.254.75.14', '185.248.85.19', '185.204.1.179', '188.241.176.195', '192.252.212.60', '193.32.126.233', '193.19.207.226', '193.19.207.196', '193.138.7.138', '193.138.7.158', '194.230.144.126', '194.230.145.67', '194.230.160.5', '194.230.147.127', '194.230.160.237', '194.230.158.178', '194.230.145.76', '194.230.158.107', '194.230.148.99', '194.230.144.50', '194.127.167.108', '194.36.25.49', '194.36.25.4', '194.127.167.88', '194.127.199.32', '194.110.115.3', '194.110.115.35', '194.36.25.34', '194.127.199.3', '195.160.223.23', '198.54.135.99', '198.54.130.153', '198.54.135.67', '198.44.136.56', '198.44.136.82', '198.44.129.82', '198.54.131.152', '198.54.135.35', '198.44.136.35', '198.54.130.147', '198.44.136.195', '198.44.129.67', '198.54.133.163', '198.54.134.131', '198.44.129.99', '198.54.134.99', '198.54.135.131', '198.44.136.99', '198.54.133.131', '198.54.130.99', '198.54.131.131', '198.44.136.67', '198.44.140.195', '198.54.130.131', '198.54.131.163', '198.44.129.35', '199.116.118.210', '199.116.118.194', '199.116.118.233', '204.152.216.105', '204.152.216.115', '204.152.216.99', '206.217.206.108', '206.217.205.49', '206.217.206.88', '206.217.206.48', '206.217.206.68', '206.217.205.118', '206.217.205.125', '206.217.205.126', '206.217.205.119', '206.217.206.28', '209.54.101.131'
    )
ORDER BY EVENT_TIMESTAMP;

-- Identifying access from suspected clients: the following query will return sessions belonging to the suspected clients.
SELECT *
FROM SNOWFLAKE.ACCOUNT_USAGE.SESSIONS
WHERE
    PARSE_JSON(CLIENT_ENVIRONMENT):APPLICATION = 'rapeflake'
    OR (
        PARSE_JSON(CLIENT_ENVIRONMENT):APPLICATION = 'DBeaver_DBeaverUltimate'
        AND PARSE_JSON(CLIENT_ENVIRONMENT):OS = 'Windows Server 2022'
    )
ORDER BY CREATED_ON;
